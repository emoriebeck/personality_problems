---
title: "Untitled"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.kable.NA = '')
```

# Workspace  
## Packages  
```{r packages}
library(gimme)
library(qgraph)
library(psych)
library(Amelia)
library(gridExtra)
library(rmarkdown)
library(forcats)
library(brms)
library(tidybayes)
library(knitr)
library(kableExtra)
library(ggridges)
library(tidybayes)
library(lubridate)
library(plyr)
library(stringr)
library(tidyverse)
library(furrr)
```

## Codebooks  
```{r codebooks}
# path to files
data_path <- "~/Box/network/other projects/personality problems/revision"

# codebook for IPCS
ipcs_trait_cb <- sprintf("%s/data/codebook_ipcs.xlsx", data_path) %>% 
  readxl::read_xlsx(sheet = "trait")
ipcs_esm_cb <- sprintf("%s/data/codebook_ipcs.xlsx", data_path) %>%
  readxl::read_xlsx(sheet = "esm")
ipcs_names <- sprintf("%s/data/codebook_ipcs.xlsx", data_path) %>%
  readxl::read_xlsx(sheet = "names")

# codebook for PAIRS
pairs_trait_cb <- sprintf("%s/data/codebook_pairs.xlsx", data_path) %>% 
  readxl::read_xlsx(sheet = "trait")
pairs_esm_cb <- sprintf("%s/data/codebook_pairs.xlsx", data_path) %>%
  readxl::read_xlsx(sheet = "esm")
pairs_names <- sprintf("%s/data/codebook_pairs.xlsx", data_path) %>%
  readxl::read_xlsx(sheet = "names")

ipcs_vars <- unique((ipcs_esm_cb %>% filter(type %in% c("personality", "problems")) %>% arrange(type))$new_name)
pairs_vars <- (pairs_esm_cb %>% filter(type %in% c("personality", "problems")) %>% arrange(type))$new_name

# keep these to make it nicer to rename facets later
big5 <- tibble(
  letter = c("E", "A", "C", "N", "O"),
  trait = c("Extraversion", "Agreeableness","Conscientiousness", "Neuroticism", "Openness")
  )
```

## Data  
### IPCS  
#### Pre-Share Cleaning  
For the purposes of this study, we are only sharing the data used in this study (for both items and participants). ESM data were pre-cleaned because data imported from jsPsych are in a format not easily interpretable within R. An R script that shows the full procedure for extracting jsPscyh data is available on the OSF page for this study. Trait data were downloaded from Qualtrics and directly imported and cleaned as shown below.  

In addition, in order to anonymize participants, we have changed their ID's using our master list, which we cannot make available because it contains identifying information.  

```{r ipcs esm data combine, eval = F}
participants <- googlesheets4::sheets_read("https://docs.google.com/spreadsheets/d/1r808gQ-LWfG98J9rvt_CRMHtmCFgtdcfThl0XA0HHbM/edit#gid=16299281", sheet = "ESM") %>%
  select(SID, Name, Email) %>%
  mutate(new = seq(1, nrow(.), 1),
         new = ifelse(new < 10, paste("0", new, sep = ""), new))
1

# wave 1 esm 
load(sprintf("%s/data/IPCS/clean_data_w1_2020-06-08.RData", data_path))

# combine waves  
BFI <- BFI %>% distinct() %>%
  mutate(SID = mapvalues(SID, participants$SID, participants$new))
old.names <- ipcs_esm_cb$old_name
emo_sit <- emotion %>% full_join(sit %>% mutate(facet = trait)) %>% distinct() %>% 
  filter(item %in% old.names) %>%
  mutate(SID = mapvalues(SID, participants$SID, participants$new))
save(BFI, emo_sit, file = sprintf("%s/data/IPCS/esm_cleaned_combined_2020-06-08.RData", data_path))
rm(list = ls())
```

```{r}
load(sprintf("%s/data/IPCS/esm_cleaned_combined_2020-06-08.RData", data_path))
```

```{r ipcs trait data combine, eval = F}
participants <- googlesheets4::sheets_read("https://docs.google.com/spreadsheets/d/1r808gQ-LWfG98J9rvt_CRMHtmCFgtdcfThl0XA0HHbM/edit#gid=16299281", sheet = "ESM") %>%
  select(SID, Name, Email) %>%
  mutate(new = seq(1, n(), 1),
         new = ifelse(new < 10, paste("0", new, sep = ""), new))
1

old_names <- ipcs_trait_cb$new_name

# wave 1 trait
ipcs_trait <- sprintf("%s/data/IPCS/baseline_05.07.20.csv", data_path) %>% 
  read_csv() %>%
  filter(!row_number() %in% c(1,2) & !is.na(SID) & SID %in% participants$SID) %>% 
  select(SID, one_of(old_names)) %>%
  mutate(SID = mapvalues(SID, participants$SID, participants$new)) 

save(ipcs_trait, file = sprintf("%s/data/IPCS/trait_cleaned_combined_2020-06-08.RData", data_path))
```

#### ESM Data Setup  
```{r ipcs esm data cleaning}
missing_fun <- function(d){
  first_day <- unique(d$StartDate)
  hourBlock <- unique(d$`Hour Block 1`)
  max_day <- max(d$Day); max_day <- ifelse(max_day < 14, 14, max_day)
  d2 <- d %>% #mutate(StartDate = ifelse(is.na(StartDate), min(Date, na.), StartDate))
    full_join(crossing(
      Day = seq(0,max_day,1),
      HourBlock = 1:6,
      StartDate = first_day,
      `Hour Block 1` = hourBlock)) %>%
    arrange(Day, HourBlock) %>%
    mutate(Date = StartDate + Day,
           Hour = ifelse(is.na(Hour), `Hour Block 1` + (HourBlock-1)*4, Hour),
           Minute = ifelse(is.na(Minute), "00", Minute))
  d2$Date[d2$Hour > 23] <- d2$Date[d2$Hour > 23] + 1
  d2$Hour[d2$Hour > 23] <- d2$Hour[d2$Hour > 23] - 24
  d2 <- d2 %>% mutate(
    Full_Date = sprintf("%s %s:%s", as.character(Date), Hour, Minute)) %>%
    select(-`Hour Block 1`, -StartDate)
}

ipcs_times <- emo_sit %>% 
  select(SID, StartDate, Date, Hour, Minute, Day, `Hour Block 1`, HourBlock) %>%
  distinct() %>%
  mutate(Minute = str_remove_all(Minute, ".csv"),
         Minute = ifelse(as.numeric(Minute) < 10, sprintf("0%s", Minute), Minute)) %>%
  arrange(SID, Date) %>%
  group_by(SID) %>%
  nest() %>%
  ungroup() %>%
  mutate(data = map(data, missing_fun)) %>%
  unnest(data) %>%
  arrange(SID, Date, Hour) %>%
  group_by(SID) %>%
  mutate(all_beeps = seq(1, n(), 1)) %>%
  ungroup()

# join with codebook, reverse code, composite within facets and spread to wide format
BFI.wide <- BFI %>% 
  select(SID, Date, Hour, Minute, item, value = responses2) %>%
  mutate(Minute = str_remove_all(Minute, ".csv"),
         Minute = ifelse(as.numeric(Minute) < 10, sprintf("0%s", Minute), Minute),
         Full_Date = sprintf("%s %s:%s", as.character(Date), Hour, Minute)) %>%
  left_join(ipcs_esm_cb %>% select(new_name, item = old_name, reverse_code)) %>%
  mutate(value = as.numeric(value),
         value = ifelse(!is.na(reverse_code) & reverse_code == "yes", reverse.code(-1, value, mini = 1, maxi = 5), value)) %>%
  select(-reverse_code) %>%
  group_by(SID, Full_Date, new_name) %>%
  summarize(value = mean(value, na.rm = T)) %>%
  ungroup() %>%
  spread(new_name, value) %>%
  group_by(SID) %>%
  arrange(SID, lubridate::ymd_hm(Full_Date)) %>%
  mutate(all_beeps = seq(1, n(), 1)) %>%
  ungroup()

emo_sit_wide <- emo_sit %>% 
  select(SID, facet, value = responses2, Date, Hour, Minute, Day, HourBlock) %>%
  mutate(Minute = str_remove_all(Minute, ".csv"),
         Minute = ifelse(as.numeric(Minute) < 10, sprintf("0%s", Minute), Minute),
         Full_Date = sprintf("%s %s:%s", as.character(Date), Hour, Minute),
         value = as.numeric(value)) %>%
  left_join(ipcs_esm_cb %>% select(new_name, facet = Facet)) %>%
  group_by(SID, Date, Hour, Minute, Day, HourBlock, Full_Date, new_name) %>% 
  summarize(value = max(value)) %>%
  ungroup() %>%
  # filter(row_number() %in% c(8673, 8674))
  spread(new_name, value) %>%
  select(SID, Full_Date, angry:tired)
```

#### Multiple Imputation  
```{r mi}
# run MI
BFI.mi <- data.frame(unclass(BFI.wide %>% select(-Full_Date)))
set.seed(5)
BFI.mi <- amelia(BFI.mi, m = 1, ts = "all_beeps", cs = "SID")$imputations[[1]] %>%
  as_tibble() %>%
  full_join(BFI.wide %>% select(SID, Full_Date, all_beeps)) %>%
  select(-all_beeps)
```

### PAIRS  
#### Pre-Share Cleaning  
```{r pairs esm data combine, eval = F}
participants <- sprintf("%s/data/PAIRS/subs.csv", data_path) %>% read_csv()
pairs_esm <- sprintf("%s/data/PAIRS/esm_w1_RENAMED.csv", data_path) %>% read_csv() %>%
  select(one_of(paste(pairs_esm_cb$old_name, "w1", sep = "."))) %>%
  setNames(pairs_esm_cb$new_name) %>%
  mutate(SID = mapvalues(SID, participants$old, participants$new))
write.csv(pairs_esm, file = sprintf("%s/data/pairs_esm_data.csv", data_path), row.names = F)
```

```{r pairs trait data combine, eval = F}
participants <- sprintf("%s/data/PAIRS/subs.csv", data_path) %>% read_csv()
pairs_trait <- sprintf("%s/data/PAIRS/target_w1_RENAMED.csv", data_path) %>% read_csv() %>%
  select(one_of(pairs_trait_cb$old_name)) %>%
  setNames(pairs_trait_cb$new_name) %>%
  mutate(SID = mapvalues(SID, participants$old, participants$new))
write.csv(pairs_trait, file = sprintf("%s/data/pairs_trait_data.csv", data_path), row.names = F)
```

#### ESM Data Setup  
```{r ipcs esm data cleaning}
missing_fun <- function(d){
  first_day <- min(mdy_hm(d$Full_Date))
  max_day <- max(d$day); max_day <- ifelse(max_day < 14, 14, max_day)
  d2 <- d %>% 
    mutate(Date = mdy_hm(Full_Date),
           Hour = hour(Date), 
           Minute = minute(Date),
           Date = as.Date(Date)) %>%
    full_join(crossing(
      day = seq(0,max_day,1),
      hourBlock = 1:6,
      StartDate = as.Date(round_date(first_day, "day")))) %>%
    arrange(day, hourBlock)  %>%
    mutate(Date = StartDate + day,
           Hour = ifelse(is.na(Hour), 9 + (hourBlock-1)*4, Hour),
           Minute = ifelse(is.na(Minute), "00", ifelse(Minute < 10, paste0("0",Minute), Minute)))
  d2$Date[d2$Hour > 23] <- d2$Date[d2$Hour > 23] + 1
  d2$Hour[d2$Hour > 23] <- d2$Hour[d2$Hour > 23] - 24
  d2 <- d2 %>% mutate(
    Full_Date = sprintf("%s %s:%s", as.character(Date), Hour, Minute)) %>%
    select(-StartDate)
}

# missingness fun
pairs_esm <- sprintf("%s/data/pairs_esm_data.csv", data_path) %>% read_csv

pairs_times <- pairs_esm %>% 
  select(SID, Full_Date, hourBlock, day) %>%
  distinct() %>%
  arrange(SID, day, hourBlock) %>%
  group_by(SID) %>%
  nest() %>%
  ungroup() %>%
  mutate(data = map(data, missing_fun)) %>%
  unnest(data) %>%
  arrange(SID, day, hourBlock) %>%
  group_by(SID) %>%
  mutate(all_beeps = seq(1, n(), 1)) %>%
  ungroup()

pairs_esm <- pairs_esm %>%
  select(-beepvar, -Full_Date) %>%
  full_join(pairs_times) %>%
  arrange(SID, day, hourBlock)
```

#### Multiple Imputation  
```{r mi}
# run MI
pairs.mi <- data.frame(unclass(pairs_esm %>% select(-freq, -hourBlock, -day, -Full_Date, -(Date:Minute))))
set.seed(5)
pairs.mi <- amelia(pairs.mi, m = 1, ts = "all_beeps", cs = "SID")$imputations[[1]] %>%
  as_tibble() %>%
  full_join(pairs_esm %>% select(SID, all_beeps, day, hourBlock, Full_Date)) 
```

#### ICC's
```{r}
nested_icc <- emo_sit_wide %>%
  full_join(BFI.mi) %>%
  pivot_longer(cols = c(-SID, -Full_Date)
               , names_to = "item"
               , values_to = "value") %>%
  mutate(study = "IPCS") %>%
  full_join(pairs.mi %>%
      pivot_longer(cols = c(-SID, -(all_beeps:Full_Date))
                   , names_to = "item"
                   , values_to = "value") %>%
      mutate(study = "PAIRS", SID = as.character(SID))) %>%
  group_by(study, item) %>%
  nest() %>%
  ungroup() %>% 
  mutate(mod = map(data, ~lme4::lmer(value ~ 1 + (1 | SID), data = .)),
         ICC = map_dbl(mod, reghelper::ICC))

nested_icc %>% select(-data, -mod)
```


# Gimme  
## Data Setup  
```{r gimme data fun}
rep_fun <- function(x){if(sd(x, na.rm = T) == 0 | any(table(x) == 1)){x[sample(1:length(x), length(x)/2)] <- jitter(unique(x[!is.na(x)])[1])}; return(x)}

fac_fun <- function(x) {
  if(length(unique(x[!is.na(x)]))==1){
    replace <- c(0,1)[!0:1 %in% unique(x[!is.na(x)])[1]]
    x[sample(1:length(x), 4)] <- replace
  } else if (any(table(x) == 1)){
    replace <- c(0,1)[which(table(x) <= 1)]
    x[sample(1:length(x), 4)] <- replace
  }
  x
}

all_na <- function(d){sum(apply(d, 2, function(x) sum(!is.na(x)) < 20)) == 0}
```

### IPCS  
```{r ipcs gimme data}
sep_fun <- function(d){
  p_cols <- unique((ipcs_esm_cb %>% filter(type %in% c("personality", "problems")))$new_name)
  tibble(model = c("none", "argument", "AnxSWk", "tired", "sick"),
         data = list(d)) %>%
    mutate(data = map2(data, model, ~(.x) %>% select(one_of(c(p_cols, .y)))))
}

normlz_fun <- function(d){
  final <- d %>%
    mutate(tdif = as.numeric(difftime(ymd_hm(Full_Date), lag(ymd_hm(Full_Date)), units = "hours"))) %>%
    filter(tdif > 1) %>%
    gather(key = item, value = value, angry:O_IntCur) %>%
    group_by(item) %>%
    mutate(dx = (value - lag(value))/tdif,
           xp = 4*dx + lag(value),
           value = ifelse(is.na(xp), value, xp)) %>%
    select(-xp, -dx) %>%
    spread(item, value) %>%
    select(-Full_Date, -tdif)
}

ipcs_gimme <- emo_sit_wide %>%
  full_join(BFI.mi) %>%
  full_join(ipcs_times %>% select(SID, Full_Date)) %>%
  arrange(SID, lubridate::ymd_hm(Full_Date)) %>%
  group_by(SID) %>%
  nest() %>%
  filter(map_lgl(data, all_na)) %>%
  unnest(data) %>%
  group_by(SID) %>%
  nest() %>%
  ungroup() %>%
  mutate(data = map(data, normlz_fun)) %>%
  unnest(data) %>%
  mutate_at(vars(angry, A_Cmpn:O_IntCur), rep_fun) %>%
  mutate_at(vars(AnxSWk:tired), fac_fun) %>%
  group_by(SID) %>%
  nest() %>%
  mutate(data = map(data, sep_fun)) %>%
  unnest(data) %>%
  group_by(model) %>% 
  nest() %>%
  ungroup()
```

### PAIRS  
```{r pairs gimme data}
rev_fun <- function(x) reverse.code(-1, x, mini = 1, maxi = 5)

normlz_fun <- function(d){
  final <- d %>%
    mutate(tdif = as.numeric(difftime(ymd_hm(Full_Date), lag(ymd_hm(Full_Date)), units = "hours"))) %>%
    filter(is.na(tdif) | tdif > 1) %>%
    gather(key = item, value = value, A_rude:negEmo) %>%
    group_by(item) %>%
    mutate(dx = (value - lag(value))/tdif,
           xp = 4*dx + lag(value),
           value = ifelse(is.na(xp), value, xp)) %>%
    select(-xp, -dx) %>%
    spread(item, value) %>%
    select(-Full_Date, -tdif, -Date, -Hour, -Minute)
}

pairs_gimme <- pairs.mi %>%
  mutate_at(vars(authentic, self_esteem), rev_fun) %>%
  full_join(pairs_times) %>%
  arrange(SID, all_beeps) %>%
  select(-hourBlock, -day, -(all_beeps:Minute)) %>%
  group_by(SID) %>%
  nest() %>%
  ungroup() %>%
  filter(map_lgl(data, all_na)) %>%
  unnest(data) %>%
  # filter(complete.cases(.)) %>%
  mutate_at(vars(-SID), rep_fun) %>%
  group_by(SID) %>%
  nest() %>%
  ungroup() %>%
  mutate(#data = map(data, normlz_fun),
         model = "none") %>%
  group_by(model) %>%
  nest() %>% 
  ungroup() 
```

## Run Models  
```{r}
gimme_fun <- function(df, study, model){
  vars <- if(study == "IPCS") ipcs_vars else pairs_vars
  vars <- if(model != "none") c(vars, model) else vars
  paths <- crossing(V1 = vars, V2 = vars) %>% filter(V1 != V2)
  paths <- paste0(c(paste(paths$V1, "~", paths$V2),
             paste(vars, "~", paste(vars, "lag", sep = ""))), collapse = "\n")
  l <- df$data
  names(l) <- df$SID
  g <- gimme(data = l
             , out = sprintf("~/Desktop/gimme/%s/%s", study, model)
             , sep = ","
             , header = T
             # , paths = paths
             )  
  save(g, file = sprintf("~/Desktop/gimme/%s/gimme_%s.RData", study, model))
  rm(list = c("l", "study", "model", "g"))
  gc()
  return(NULL)
}
```

```{r run gimme, eval = F}
plan(multisession(workers = 4L))
ipcs_gimme %>% mutate(study = "IPCS") %>%
  bind_rows(pairs_gimme %>% mutate(study = "PAIRS")) %>%
  mutate(gimme = future_pmap(list(data, study, model)
                             , gimme_fun
                             , .progress = T))
closeAllConnections()

ipcs_gimme %>% mutate(study = "IPCS") %>%
  bind_rows(pairs_gimme %>% mutate(study = "PAIRS")) %>%
  filter(study == "IPCS" & model == "none") %>%
  mutate(gimme = pmap(list(data, study, model)
                             , gimme_fun))
```

## Load Results  
```{r Q1 load gimme results}
# function ofr loading in idiographic estimates
ind_load_fun <- function(sid, model, study){
  cb <- if(study == "PAIRS") pairs_names else ipcs_names
  cb <- cb %>% filter(type %in% c("personality", "problems") | old == model)
  items <- cb$old; lagitems <- c(items, paste0(items, "lag"))
  sprintf("%s/results/gimme/%s/%s/individual/%sBetas.csv", data_path, study, model, sid) %>% 
    read_csv() %>%
    rename(to = X1) %>% 
    filter(to %in% items) %>% select(to, one_of(lagitems))
}

# function ofr loading in group estimates
group_load_fun <- function(model, study){
  cb <- if(study == "PAIRS") pairs_names else ipcs_names
  cb <- cb %>% filter(type %in% c("personality", "problems") | old == model) %>% arrange(type, old)
  items <- cb$old; lagitems <- c(items, paste0(items, "lag"))
  d <- sprintf("%s/results/gimme/%s/%s/indivPathEstimates.csv", data_path, study, model) %>% 
    read_csv() %>%
    filter(level == "group" & lhs %in% lagitems & rhs %in% lagitems) %>%
    select(SID = file, to = lhs, from = rhs, value = beta) %>% #, type) %>%
    group_by(from, to) %>% #, type) %>%
    summarize(value = mean(value, na.rm = T)) %>%
    ungroup() %>%
    pivot_wider(names_from = "from", values_from = "value") 
  crossing(to = items, from = factor(lagitems, levels = lagitems), value = NA_real_) %>% 
    pivot_wider(names_from = "from", values_from = "value") %>%
    right_join(d)
}

# individual paths for gimme
gimme_nested <- tibble(study = "PAIRS", model = "none") %>%
  full_join(tibble(study = "IPCS", model = c("none", "argument", "sick", "tired", "AnxSWk"))) %>%
  mutate(SID = map2(study, model, ~list.files(sprintf("%s/results/gimme/%s/%s/individual", data_path, .x, .y), pattern = "Betas.csv"))) %>%
  unnest(SID) %>%
  mutate(SID = str_remove_all(SID, "Betas.csv")) %>%
  mutate(gimme = pmap(list(SID, model, study), ind_load_fun)) 
gimme_nested

# group paths for gimme
gimme_group <- tibble(study = "PAIRS", model = "none") %>%
  full_join(tibble(study = "IPCS", model = c("none", "argument", "sick", "tired", "AnxSWk"))) %>%
  mutate(gimme = map2(model, study, group_load_fun)) %>%
  mutate(SID = "Group")
gimme_group
```

### Reshape Results  
```{r}
PDC_fun <- function(df){
  # keep only lagged associations
  df <- df %>% select(to, contains("lag")) 
  if(any(dim(df) == 0)){df <- matrix(rep(0, length(rn)^2), nrow = length(rn), dimnames = list(rn, rn)) %>% data.frame() %>% rownames_to_column("to")}
  colnames(df) <- str_remove_all(colnames(df), "lag")
  df <- df %>% mutate_all(~ifelse(is.na(.), 0, .))
  return(df)
}

# create matrix of lagged associations
combined_fun <- function(df){
  if(any(dim(df) == 0)){df <- matrix(rep(0, length(rn)*2*length(rn)), nrow = length(rn), dimnames = list(rn, c(rn, paste0(rn, "lag")))) %>% data.frame() %>% rownames_to_column("to")}
  df <- df %>% mutate_all(~ifelse(is.na(.), 0, .))
  return(df)
}

# create matrix of contemporaneous associations
PCC_fun <- function(df, study, model){
  cb <- if(study == "PAIRS") pairs_names else ipcs_names
  cb <- cb %>% 
    filter(type %in% c("personality", "problems") | old == model) %>%
    arrange(type)
  # keep only non-lagged associations
  rn <- colnames(df); rn <- rn[2:length(rn)]; rn <- rn[!grepl("lag", rn)]
  df <- df %>% 
    mutate(to = factor(to, cb$old)) %>% 
    arrange(to) %>%
    select(all_of(cb$old)) %>% 
    mutate_all(~ifelse(is.na(.), 0, .)) 
  if(any(dim(df) == 0)){df <- matrix(rep(0, length(rn)^2), nrow = length(rn), dimnames = list(rn, rn))}
  df <- as.matrix(df)
  rownames(df) <- cb$old
  # symmetricize
  PCC <- apply(simplify2array(list(df, t(df))), 1:2, mean)
  diag(PCC) <- NA
  PCC <- data.frame(PCC) %>% rownames_to_column("to")
  return(PCC)
}

# change matrices to long form
long_fun <- function(df){df %>% gather(key = from, value = value, -to, na.rm = T)}

gimme_nested <- gimme_nested %>% 
  full_join(gimme_group) %>%
  full_join(implaus) %>% filter(is.na(n)) %>% # remove participants with model errors
  mutate(uSEM = map(gimme, combined_fun),
         PDC = map(gimme, PDC_fun),
         PCC = pmap(list(gimme, study, model), PCC_fun),
         Combined = map(uSEM, long_fun),
         Lagged = map(PDC, long_fun),
         Contemporaneous = map(PCC, long_fun))
```

## Plot Networks  
```{r}
edge_colors <- RColorBrewer::brewer.pal(8, "Purples")[c(4,6,8)]

idio_plot_fun <- function(data, subject, model, type, study){
  n <- nrow(data)
  cb <- if(study == "PAIRS") pairs_names else ipcs_names
  cb <- cb %>% 
    filter(type %in% c("personality", "problems") | old == model) %>%
    arrange(type)
  tmp <- cb %>% mutate(num = seq(1, n(), 1)) %>% select(-old, -new) %>%
    group_by(type) %>% nest() %>% ungroup() %>% 
    mutate(data = map(data, ~(.)$num))
  p_groups <- tmp$data; names(p_groups) <- tmp$type
  ng <- length(p_groups); n_num <- map_dbl(p_groups, length)
  cols <- rev(c("white", t(RColorBrewer::brewer.pal(9, "Purples"))[c(3,7)]))[1:ng]
  data <- data %>% select(to, one_of(cb$old)) %>%
    filter(to %in% cb$old) %>%
    mutate(to = factor(to, levels = cb$old)) %>% 
    arrange(to)
  dir <- if (type == "Contemporaneous") F else T
  plot <- 
    qgraph(data %>% select(-to)
           , layout = "spring"
           , loop = .7
           , node.width = 1.8
           , edge.width = 1
           , esize = 7
           , title = sprintf("%s: %s for S%s, %s", study, type, subject, model)
           , label.font = 2
           , repulsion = .8
           , directed = dir
           , label.fill.vertical = 1
           , label.fill.horizontal = 1
           , edge.color = "black"
           , groups = p_groups
           , color = cols
           , legend = F
           , DoNotPlot = TRUE
           , mar = c(4,4,4,4)
           , asize = 6)
  #change lines to dashed
  plot$graphAttributes$Edges$lty[plot$Edgelist$weight < 0] <- 2
  #change line colors
  plot$graphAttributes$Edges$color <-
    ifelse(abs(plot$Edgelist$weight) <.1, edge_colors[1],
    ifelse(abs(plot$Edgelist$weight) <.2, edge_colors[2], edge_colors[3]))
  dark_colors <- c("#9E9AC8", "#807DBA", "#6A51A3", "#54278F", "#3F007D")
  plot$graphAttributes$Nodes$label.color[plot$graphAttributes$Nodes$color %in% dark_colors] <- "white"
  vars <- names(plot$graphAttributes$Nodes$labels)
  #change variable names
  plot$graphAttributes$Nodes$labels <- 
    mapvalues(vars, cb$old, str_replace(cb$new, "[ ]", "\n"), warn_missing = F)
  return(plot)
}

gimme_nested <- gimme_nested %>% 
  mutate(lagged_plot = pmap(list(PDC, SID, model, "Lagged", study),
                          possibly(idio_plot_fun, NA_real_)),
         contemp_plot = pmap(list(PCC, SID, model, "Contemporaneous", study),
                          possibly(idio_plot_fun, NA_real_)))
```

```{r}
pdf(file = sprintf("%s/results/plots/networks/Figure_1.pdf", data_path)
      , width = 8
      , height = 8)
  par(mfrow = c(2,2))
  plot((gimme_nested %>% filter(SID == "68273"))$contemp_plot[[1]])
  plot((gimme_nested %>% filter(SID == "81347"))$contemp_plot[[1]])
  plot((gimme_nested %>% filter(SID == "150" & model =="none"))$contemp_plot[[1]])
  plot((gimme_nested %>% filter(SID == "160" & model =="none"))$contemp_plot[[1]])
  dev.off()
```


```{r, eval = F}
save_fun <- function(p1, p2, subject, model, study){
  pdf(file = sprintf("%s/results/plots/networks/%s/%s/%s.pdf", data_path, study, model, subject)
      , width = 8
      , height = 4)
  par(mfrow = c(1,2))
  plot(p1)
  plot(p2)
  dev.off()
}

gimme_nested %>% 
  mutate(pmap(list(lagged_plot, contemp_plot, SID, model, study), save_fun))
```


# Q1: Structural Differences of Personality and Problems  
## Edgewise  
First, we need to bring in information about how often personality and problems relate.  

```{r}
cb_fun <- function(d1, study, model){
  cb <- if(study == "PAIRS") pairs_esm_cb else ipcs_esm_cb
  cb <- cb %>% 
    filter(type %in% c("personality", "problems") | new_name == model) %>%
    arrange(type)
  d2 <- d1 %>% as_tibble() %>%
    # filter(value != 0) %>%
    left_join(cb %>% select(from = new_name, from_type = type)) %>%
    left_join(cb %>% select(to = new_name, to_type = type)) %>%
    full_join(crossing(from_type = c("personality", "problems"),
                       to_type = c("personality", "problems"),
              value = 0)) %>%
    distinct() 
}

PCC_remove_upper <- function(df){
  rownames(df) <- df$to
  m <- df %>% select(-to) %>% as.matrix
  m[upper.tri(m, diag = T)] <- NA
  m %>% data.frame %>% 
    rownames_to_column("to") %>% 
    gather(key = "from", value = "value", -to, na.rm = T)
}

gimme_nested <- gimme_nested %>% 
  mutate(Contemporaneous = map(PCC, PCC_remove_upper),
         Contemporaneous = pmap(list(Contemporaneous, study, model), cb_fun),
         Lagged = pmap(list(Lagged, study, model), cb_fun))

edge_match <- gimme_nested %>% select(study:SID, Lagged, Contemporaneous) %>%
  pivot_longer(cols = c("Lagged", "Contemporaneous")
               , names_to = c("type")
               , values_to = "network") %>%
  unnest(network) %>%
  filter(complete.cases(.)) %>%
  mutate(match = ifelse(from_type == to_type, "Matched", "Not Matched")) 
```

#### Tables  
```{r}
edge_sum <- edge_match %>%
  group_by(study, model) %>%
  mutate(N = length(unique(SID))) %>%
  group_by(study, model, type, from, to, N, match, from_type, to_type) %>%
  summarize(n = sum(value != 0)) %>%
  ungroup() %>%
  mutate(perc = n/N,
         var = ifelse(type == "Contemporaneous", paste(from, to, sep = "--"), 
                      paste(from, to, sep = "-->")))

Q1_tab_fun <- function(d1, study, type){
  c_names <- if(type == "Lagged") c("From", "To") else c("V1", "V2")
  d1 %>% 
    select(match, everything(), -from_type, -to_type) %>%
    arrange(match, desc(perc)) %>%
    kable(.
          , "html"
          , col.names = c("Matched", c_names, "Frequency", "Percentage")
          , caption = sprintf("Frequencies of Personality-Problem Relationships for %s Relationships in %s", type, study)
    ) %>%
    kable_styling(full_width = F) %>%
    collapse_rows(1, valign = "top") %>%
    save_kable(., file = sprintf("%s/results/tables/Q1/%s_%s_frequencies.html", data_path, study, type))
}

edge_sum %>% 
  mutate(perc = round(perc*100,2)) %>%
  filter(model == "none") %>%
  select(-N, -model, -var) %>%
  group_by(study, type) %>%
  nest() %>%
  ungroup() %>%
  mutate(pmap(list(data, study, type), Q1_tab_fun))
```

#### Figures  
```{r}
Q1_plot_fun <- function(d1, study, type, model){
  vars <- if(study == "IPCS") ipcs_names else pairs_names
  vars <- vars %>% filter(type %in% c("personality", "problems") | old == model)
  p <- d1 %>% 
    mutate_at(vars(from_type, to_type), ~factor(., levels = c("personality", "problems"),
            labels = c("Personality", "Problems"))) %>%
    # unite(from, from_type, from, sep = " ", remove = F) %>%
    # unite(to, to_type, to, sep = " ", remove = F) %>%
    mutate_at(vars(from, to), ~factor(., levels = vars$old, labels = vars$new)) %>%
    mutate(from = forcats::fct_rev(from)) %>%
    ggplot(aes(x = to, y = from)) +
      scale_color_manual(values = c("blue", "red")) +
      scale_size_area(limits = c(0, 50), breaks = seq(10,40,10)
                      , max_size = 7, labels = seq(30,60,10)) +
      geom_point(aes(color = match, size = perc-20)) +
      labs(x = NULL, y = NULL, size = "Percentage", color = NULL)+
      facet_grid(from_type~to_type, scales = "free",space = "free") +
      theme_classic() +
      theme(legend.position = "bottom",
            axis.text.y = element_text(face = "bold"),
            axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
            panel.background = element_rect(color = "black", fill = "white"),
            strip.text = element_text(face = "bold", size = rel(1)),
            strip.background = element_blank())
  ggsave(filename = sprintf("%s/results/plots/Q1/edges/%s_%s_%s.png", data_path, study, type, model), 
         width = 8, height = 8)
  return(p)
}

edge_plot <- edge_sum %>% 
  mutate(perc = round(perc*100,2)) %>%
  select(-N, -var) %>%
  group_by(study, type, model) %>%
  nest() %>%
  ungroup() %>%
  mutate(p = pmap(list(data, study, type, model), Q1_plot_fun))

p <- cowplot::plot_grid(
  (edge_plot %>% filter(type == "Contemporaneous" & study == "PAIRS"))$p[[1]] + theme(legend.position = "none")
  , (edge_plot %>% filter(type == "Contemporaneous" & study == "IPCS" & model == "none"))$p[[1]] + theme(legend.position = "none")
  , rel_widths = c(.48, .52)
  , axis = "tblr"
  , align = "hv")
legend <- cowplot::get_legend(
  (edge_plot %>% filter(type == "Contemporaneous" & study == "PAIRS"))$p[[1]] + theme(legend.position = "bottom"))
  p2 <- cowplot::plot_grid(p
                     , legend
                     , nrow = 2
                     , rel_heights = c(4, .4))
p2
ggsave(plot = p2
       , file = sprintf("%s/results/plots/Q1/Figure_2.pdf", data_path)
       , width = 11
       , height = 5.5)
```


## Node-wise  
### Define Matches  
```{r}
match_fun <- function(d1, type, study){
  vars <- if(study == "PAIRS") pairs_names else ipcs_names
  vars <- vars %>% filter(type %in% c("personality", "problems"))
  d2 <- d1 %>%
    mutate(var = paste(from_type, to_type, sep = "--"),
           match = ifelse(from_type == to_type, "match", "no_match")) %>%
    filter(from != to) %>%
    filter(from_type != "situation" & to_type != "situation")
  nprs <- sum(vars$type=="personality"); nprb <- nrow(vars)-nprs
  ncprsm <- nprs-1; ncprsn <- nprb; ncprbm <- nprb-1; ncprbn <- nprs
  nmatch <- crossing(from_type = c("personality", "problems"),
           to_type = c("personality", "problems")) %>%
    mutate(match = ifelse(from_type == to_type, "match", "no_match"),
           from_nc = c(ncprsm, ncprsn, ncprbn, ncprbm),
           to_nc = c(ncprsm,  ncprbn, ncprsn, ncprbm))
  
  d3 <- d2 %>% 
    full_join(nmatch) %>%
    group_by(from, match, from_nc) %>%
    summarize(out_strength = sum(abs(value)),
              out_degree = sum(abs(value) > 0)) %>%
    ungroup() %>% 
    mutate(out_degree = out_degree/from_nc*10) %>%
    rename(var = from) %>%
    select(-from_nc) %>%
    full_join(
      d2 %>% 
      full_join(nmatch) %>%
      group_by(to, match, to_nc) %>%
      summarize(in_strength = sum(abs(value)),
                in_degree = sum(abs(value) > 0)) %>%
      ungroup() %>%
      mutate(in_degree = in_degree/to_nc*10) %>%
      rename(var = to) %>%
      select(-to_nc)
    ) 
  if(type == "Contemporaneous"){
    d3 <- d3 %>% 
      mutate_at(vars(-var, -match), ~ifelse(is.na(.), 0, .)) %>%
      group_by(var, match) %>%
      summarize(strength = out_strength + in_strength,
                degree = out_degree + in_degree) %>%
      ungroup() %>%
      select(-contains("out"), -contains("in_")) 
  } 
  d3 <- d3 %>%
    gather(measure, node_cent, -var, -match)
}

node_match <- gimme_nested %>%
  select(study:SID, Lagged, Contemporaneous) %>%
  pivot_longer(cols = c("Lagged", "Contemporaneous")
               , names_to = c("type")
               , values_to = "e_list") %>%
  mutate(match = pmap(list(e_list, type, study), match_fun))
```

### Plots  
```{r}
meas <- tibble(
  old = c("strength", "degree", "in_strength", "out_strength", "in_degree", "out_degree")
) %>%
  mutate(new = str_to_title(str_replace(old, "_", " ")))
Q1_node_plot_fun <- function(d1, study, model, type){
  cb <- if(study == "PAIRS") pairs_names else ipcs_names
  cb <- cb %>% filter(type %in% c("personality", "problems")) %>% arrange(type)
  p <- d1 %>%
    left_join(cb %>% rename(var = old, var_type = type)) %>%
    filter(!is.na(var)) %>%
    mutate(var = factor(var, levels = cb$old, labels = cb$new),
           measure = factor(measure, levels = meas$old, labels = meas$new),
           match = str_to_title(str_replace(match, "_", " ")),
           var_type = str_to_title(var_type)) %>%
    distinct() %>%
    ggplot(aes(x = var, y = node_cent, shape = match)) +
      # scale_y_continuous(limits = c(-.05, .80), breaks = seq(0, .8, .25)) +
      geom_line(aes(group = match, linetype = match)) +
      geom_point() +
      labs(y = "Centrality", x = NULL, shape = "Matched", linetype = "Matched") +
      coord_flip() +
      facet_grid(var_type~measure, scales = "free", space = "free_y") +
      theme_classic() +
      theme(legend.position = "bottom",
            axis.text = element_text(face = "bold"),
            panel.background = element_rect(color = "black", fill = "white"),
            strip.text = element_text(face = "bold", size = rel(.8)),
            strip.background = element_blank())
  ggsave(p, file = sprintf("%s/results/plots/Q1/nodes/%s_%s_%s.png", data_path, study, model, type)
         , width = if (type == "Lagged") 6 else 4
         , height = 5)
  p
}

node_sum <- node_match %>% 
  select(-e_list) %>%
  unnest(match) %>%
  group_by(study, model, SID, type, match, measure) %>%
  mutate(node_cent = as.numeric(scale(node_cent)),
         node_cent = ifelse(is.nan(node_cent), 0, node_cent)) %>%
  group_by(study, model, type, var, match, measure) %>%
  summarize(node_cent = mean(node_cent)) %>%
  distinct() %>%
  group_by(study, model, type) %>%
  nest() %>%
  ungroup() %>%
  mutate(p = pmap(list(data, study, model, type), Q1_node_plot_fun))

p <- cowplot::plot_grid(
  (node_sum %>% filter(study == "PAIRS"))$p[[1]] + 
    theme(legend.position = "none"
          , axis.text.x = element_blank()
          , axis.title.x = element_blank()) 
  , (node_sum %>% filter(study == "IPCS" & model == "none"))$p[[1]] + theme(legend.position = "none")
  , axis = "lrtb"
  , align = "hv"
  , nrow = 2
  , rel_heights = c(.45, .55)
)

legend <- cowplot::get_legend((node_sum %>% filter(study == "PAIRS"))$p[[1]])

p2 <- cowplot::plot_grid(p
                   , legend
                   , nrow = 2
                   , rel_heights = c(4, .4))
p2
ggsave(file = sprintf("%s/results/plots/Q1/Figure_3.pdf", data_path)
       , width = 5
       , height = 8)
```

## Network  
### Define Matches  
```{r}
net_match <- node_match %>% 
  select(-e_list) %>%
  unnest(match) %>%
  group_by(study, model, SID, type, match, measure) %>%
  summarize(node_cent = sum(node_cent, na.rm = T)) %>%
  ungroup()
```

### Plots  
```{r}
net_match %>%
  filter(model == "none") %>%
  ggplot(aes(x = node_cent, y = measure)) +
    geom_density_ridges(aes(fill = match), alpha = .25) + 
    facet_grid(type~study, scales = "free_y", space = "free_y") +
    theme_classic()
```

# Q2: The Relationship between Personality and Problems Structure and Clinical Prediction  

First, we need to create measures of how well personality and problems are distinct. To do so, we'll look at node-wise properties of problems and personality, counting the number of connections each shares with other nodes to which they putatively belong or not. 

## Bring in CESD Scores  
```{r}
rev_code <- function(x) psych::alpha(-1, x, 0, 3)
# IPCS CESD Data  
load(sprintf("%s/data/IPCS/trait_cleaned_combined_2020-06-08.RData", data_path))
ipcs_trait <- ipcs_trait %>% 
  group_by(SID) %>% filter(row_number() == 1) %>% ungroup() %>%
  gather(new_name, value, -SID) %>%
  left_join(ipcs_trait_cb %>% select(new_name, reverse_code)) %>%
  mutate(value = as.numeric(value) - 1,
         value = ifelse(reverse_code == 1, value,
            psych::reverse.code(-1, value, mini = 0, maxi = 3))) %>%
  select(-reverse_code)
ipcs_alpha <- psych::alpha(ipcs_trait %>% pivot_wider(values_from = "value", names_from = "new_name") %>% select(-SID))
ipcs_trait <- ipcs_trait %>% 
  group_by(SID) %>%
  summarize(CESD  = sum(value, na.rm = T)) %>%
  ungroup() %>%
  mutate(cutoff = ifelse(CESD >= 16, "clinical", "non-clinical"))

# PAIRS CESD Data  
pairs_trait <- sprintf("%s/data/pairs_trait_data.csv", data_path) %>% 
  read_csv(., col_types = cols(SID = col_character())) %>%
  group_by(SID) %>% filter(row_number() == 1) %>% ungroup() %>%
  gather(new_name, value, -SID, na.rm = T) %>%
  left_join(pairs_trait_cb %>% select(new_name, reverse_code)) %>%
  mutate(value = as.numeric(value) - 1,
         value = ifelse(reverse_code == "no", value,
            psych::reverse.code(-1, value, mini = 0, maxi = 3))) %>%
  select(-reverse_code)
pairs_alpha <- psych::alpha(pairs_trait %>% pivot_wider(values_from = "value", names_from = "new_name") %>% select(-SID))
pairs_trait <- pairs_trait %>% 
  group_by(SID) %>%
  summarize(CESD  = sum(value, na.rm = T)) %>%
  ungroup() %>%
  mutate(cutoff = ifelse(CESD >= 10, "clinical", "non-clinical"))
cesd <- pairs_trait %>% mutate(study = "PAIRS") %>%
  full_join(ipcs_trait %>% mutate(study = "IPCS")) %>%
  gather(cesd_type, cesd, CESD, cutoff)

cat("Cronbach's alpha for CES-D was", round(ipcs_alpha$total$raw_alpha,2), "for the IPCS Study and", round(pairs_alpha$total$raw_alpha,2), "for the PAIRS Study.")
```

## Mean-level differences in degree and strength across depression groups  
```{r}
Q2_nested_mods <- 
  
  # edge level 
  edge_match %>%
    # filter(model == "none") %>%
    mutate(level = "edge") %>%
    full_join(cesd) %>%
    filter(complete.cases(.)) %>%
    unite(var, from, to, sep = "-") %>%
    group_by(study, model, type, var, match, level, cesd_type) %>%
    nest() %>%
    ungroup() %>%
    
  full_join(
  
  # node level 
  node_match %>%
    select(-e_list) %>%
    unnest(match) %>%
    # filter(model == "none") %>%
    mutate(level = "node") %>%
    rename(value = node_cent) %>%
    full_join(cesd) %>%
    filter(complete.cases(.)) %>%
    group_by(study, model, type, var, match, measure, level, cesd_type) %>%
    nest() %>%
    ungroup()
  
  ) %>% full_join(
  
  # network level 
  net_match %>%
    # filter(model == "none") %>%
    mutate(level = "network") %>%
    rename(value = node_cent) %>%
    full_join(cesd) %>%
    filter(complete.cases(.)) %>%
    group_by(study, model, type, match, measure, level, cesd_type) %>%
    nest() %>%
    ungroup()
  
  )
```

### Run Models  
```{r, eval = F}
data_fun <- function(d1, type){
  if(type == "cutoff"){
    d1 <- d1 %>% mutate(cesd = factor(cesd, levels = c("non-clinical", "clinical")))
  } else{d1 <- d1 %>% mutate(cesd = as.numeric(cesd))}
    d1
}

setup_fun <- function(d1, m){
  res <- update(m, newdata = .)
  gc()
  return(res)
}

# get estimates and lower and upper bounds as a data frame
tidy_brms <- function(mod){
  fixef(mod, probs = c(.025, .975)) %>%
    data.frame() %>%
    rownames_to_column("term")
}

m <- brm(value ~ cesd, data = Q2_nested_mods$data[[1]])
gc()
plan(multisession(workers = 4L))
Q2_nested_mods <- Q2_nested_mods %>%
  mutate(data = map2(data, cesd_type, data_fun)
        , mod = future_map(data
            , possibly(~update(m, newdata = .), NA_real_)
            , .progress = T)
        , tidy = map(mod, tidy_brms))
closeAllConnections()
gc()
save(Q2_nested_mods, file = sprintf("%s/results/models/Q2/Q2.RData", data_path))
Q2_nested_mods <- Q2_nested_mods %>% select(-mod)
gc()
save(Q2_nested_mods, file = sprintf("%s/results/models/Q2/Q2_small.RData", data_path))
```

```{r}
load(sprintf("%s/results/models/Q2/Q2_small.RData", data_path))
```


## Tables  

```{r}
Q2_res <- Q2_nested_mods %>% 
  select(-data) %>%
  unnest(tidy) %>% 
  filter(grepl("cesd", term)) %>%
  rename(estimate = Estimate, lower = Q2.5, upper = Q97.5)
rm(Q2_nested_mods)
```

### Edges  
```{r}
Q2_edge_tab_fun <- function(d, level, type, model, study, ct){
  cb <- if(study == "PAIRS") pairs_esm_cb else ipcs_esm_cb
  cb <- cb %>% filter(type %in% c("personality", "problems") | new_name == model) %>%
    select(new_name, type) %>%
    distinct() %>%
    arrange(type)
  trm <- unique(d$term)
  vars <- cb$new_name
  npers <- sum(cb$type == "personality") 
  nprob <- sum(cb$type == "problems")
  headr1 <- c(" " = 1, "Personality" = npers, "Problems" = nprob)
  headr1 <- if(model == "none") headr1 else c(headr1, " " = 1)
  headr2 <- rep(1, length(vars) + 1); names(headr2) <- c(" ", vars)
  tab <- d %>%
    mutate(sig = ifelse(sign(lower) == sign(upper), "sig", "ns")) %>%
    mutate_at(vars(estimate, lower, upper), ~sprintf("%.2f",.)) %>%
    mutate_at(vars(estimate, lower, upper), ~str_remove(., "^0")) %>%
    mutate_at(vars(estimate, lower, upper), ~str_replace(., "^-0","-")) %>%
    mutate(est = sprintf("%s<br>[%s, %s]", estimate, lower, upper),
           est = ifelse(sig == "sig", sprintf("<strong>%s</strong>", est), est)) %>%
    separate(var, c("V2", "V1"), sep = "-") %>%
    full_join(cb %>% select(V1 = new_name, V1_type = type) %>%
                mutate(term = trm)) %>% 
    full_join(cb %>% select(V2 = new_name) %>% mutate(term = trm)) %>%
    mutate(V1 = ifelse(is.na(V1), V2, V1),
           V2 = ifelse(is.na(V2), V1, V2)) %>%
    mutate_at(vars(V1, V2), ~factor(., levels = vars, labels = str_replace_all(vars, "_", " "))) %>%
    mutate(match = factor(match)
           , V1_type = str_to_title(V1_type)) %>%
    arrange(V1_type, V1) %>%
    select(V1_type, V1, V2, est) %>%
    spread(V2, est) %>%
    select(-V1_type) %>%
    kable(.
          , "html"
          , escape = F
          , col.names = c("", rep("b [CI]", nrow(cb)))
          , align = c("r", rep("c", nrow(cb)))) %>%
    kable_styling(full_width = F) %>%
    kableExtra::group_rows("Personality", 1, npers) %>%
    kableExtra::group_rows("Problems", npers + 1, npers + nprob) %>%
    add_header_above(headr2) %>%
    add_header_above(headr1) 
  save_kable(tab, file = sprintf("%s/results/tables/Q2/%s/%s/%s_%s_%s.html",
            data_path, ct, level, study, type, model))
  return(tab)
}

Q2_edge_tab <- Q2_res %>%
  filter(level == "edge") %>%
  group_by(study, model, type, level, cesd_type) %>%
  nest() %>%
  ungroup() %>%
  mutate(tab = pmap(list(data, level, type, model, study, cesd_type), Q2_edge_tab_fun))
```

PAIRS Contemporaneous Associations  
```{r}
(Q2_edge_tab %>% filter(study == "PAIRS" & type == "Contemporaneous" & cesd_type == "CESD"))$tab[[1]]
```

IPCS Contemporaneous Associations  
```{r}
(Q2_edge_tab %>% filter(study == "IPCS" & type == "Contemporaneous" & cesd_type == "CESD" & model == "none"))$tab[[1]]
```

### Nodes  
```{r}
Q2_node_tab_fun <- function(d, ct, level, study, model){ 
  vars <- if(study == "IPCS") ipcs_vars else pairs_vars
  vars <- if(model != "none") c(vars, model) else vars
  levs <-  c("Contemporaneous_strength", "Lagged_out_strength", "Lagged_in_strength", "Contemporaneous_degree", "Lagged_out_degree", "Lagged_in_degree")
  tab <- d %>%
    mutate(sig = ifelse(sign(lower) == sign(upper), "sig", "ns")) %>%
    mutate_at(vars(estimate, lower, upper), ~sprintf("%.2f",.)) %>%
    mutate_at(vars(estimate, lower, upper), ~str_remove(., "^0")) %>%
    mutate_at(vars(estimate, lower, upper), ~str_replace(., "^-0","-")) %>%
    mutate(est = sprintf("%s<br>[%s, %s]", estimate, lower, upper),
           est = ifelse(sig == "sig", sprintf("<strong>%s</strong>", est), est),
           match = factor(match, unique(match), c("Matched", "Not Matched")), var = factor(var, levels = vars)) %>%
    select(-term, -Est.Error, -lower, -upper, -sig, -estimate) %>%
    pivot_wider(names_from = c("type", "measure")
                , values_from = est) %>% 
    select(var, match, levs) %>%
    arrange(var, match) %>%
    kable(.
          , "html"
          , escape = F
          , align = c("r", "r", rep("c", 6))
          , col.names = c("Variable", "Match", c("Strength", "Out Strength", "In Strength", "Degree", "Out Degree", "In Degree"))) %>%
    kable_styling(full_width = F) %>%
    collapse_rows(1, valign = "top") %>%
    add_header_above(c(" " = 2, "Contemporaneous" = 1, "Lagged" = 2,
                       "Contemporaneous" = 1, "Lagged" = 2))
  save_kable(tab, file = sprintf("%s/results/tables/Q2/%s/node/%s_%s.html",
                                data_path, ct, study, model))
  return(tab)
}

Q2_node_tab <- Q2_res %>%
  filter(level == "node") %>% 
  group_by(cesd_type, level, model, study) %>%
  nest() %>%
  ungroup() %>%
  mutate(tab = pmap(list(data, cesd_type, level, study, model), Q2_node_tab_fun))
```

PAIRS Contemporaneous Associations  
```{r}
(Q2_node_tab %>% filter(study == "PAIRS" & cesd_type == "CESD"))$tab[[1]]
```

IPCS Contemporaneous Associations  
```{r}
(Q2_node_tab %>% filter(study == "IPCS" & cesd_type == "CESD" & model == "none"))$tab[[1]]
```

### Networks  
```{r}
Q2_network_tab_fun <- function(d, ct, model){
  tab <- d %>% 
    pivot_wider(names_from = c("study", "match")
              , values_from = "est") %>%
    mutate(measure = str_to_title(str_replace_all(measure, "_", " "))) %>%
    kable(.
          , "html"
          , escape = F
          , align = c(rep("r", 2), rep("c", 4))
          , col.names = c("", "Measure", rep(c("Matched", "Not Matched"), times = 2))) %>%
    kable_styling(full_width = F) %>% 
    collapse_rows(1:2, valign = "top") %>%
    add_header_above(c(" " = 2, "IPCS" = 2, "PAIRS" = 2))
  save_kable(tab, file = sprintf("%s/results/tables/Q2/%s/network/%s.html",
                                data_path, ct, model))
  return(tab)
}

Q2_net_tab <- Q2_res %>%
  filter(level == "network" & model == "none") %>%
    mutate(sig = ifelse(sign(lower) == sign(upper), "sig", "ns")) %>%
    mutate_at(vars(estimate, lower, upper), ~sprintf("%.2f",.)) %>%
    mutate_at(vars(estimate, lower, upper), ~str_remove(., "^0")) %>%
    mutate_at(vars(estimate, lower, upper), ~str_replace(., "^-0","-")) %>%
    mutate(est = sprintf("%s<br>[%s, %s]", estimate, lower, upper),
           est = ifelse(sig == "sig", sprintf("<strong>%s</strong>", est), est),
           match = factor(match, unique(match), c("Matched", "Not Matched"))) %>%
    select(cesd_type, study, type, match, measure, est, model) %>%
  group_by(cesd_type, model) %>% 
  nest() %>%
  ungroup() %>%
  mutate(tab = pmap(list(data, cesd_type, model), Q2_network_tab_fun))
```

```{r}
Q2_net_tab$tab[[1]]
```


```{r}
Q3_network_tab_fun <- function(d, ct){
  d %>% 
  kable(.
        , "html"
        , escape = F
        , align = c(rep("r", 2), rep("c", 4))
        , col.names = c("", "Model", "Measure", "Matched", "Not Matched")) %>%
  kable_styling(full_width = F) %>% 
  collapse_rows(1:2, valign = "top") %>%
  add_header_above(c(" " = 3, "IPCS" = 2)) %>%
    save_kable(., file = sprintf("%s/results/tables/Q2/%s/network/sit_tab.html",
                                data_path, ct))
}

Q2_res %>%
  filter(level == "network" & model != "none") %>%
    mutate(sig = ifelse(sign(lower) == sign(upper), "sig", "ns")) %>%
    mutate_at(vars(estimate, lower, upper), ~sprintf("%.2f",.)) %>%
    mutate_at(vars(estimate, lower, upper), ~str_remove(., "^0")) %>%
    mutate_at(vars(estimate, lower, upper), ~str_replace(., "^-0","-")) %>%
    mutate(est = sprintf("%s<br>[%s, %s]", estimate, lower, upper),
           est = ifelse(sig == "sig", sprintf("<strong>%s</strong>", est), est),
           match = factor(match, unique(match), c("Matched", "Not Matched"))) %>%
    select(cesd_type, study, type, model, match, measure, est) %>% 
    pivot_wider(names_from = c("study", "match")
              , values_from = "est") %>%
  group_by(cesd_type) %>%
  nest() %>%
  ungroup() %>%
  mutate(map2(data, cesd_type, Q3_network_tab_fun))
```


## Plots  
### Edge-wise  
```{r}
Q2_plot_fun <- function(d2, study, type, model, ct){
  vars <- if(study == "IPCS") ipcs_names else pairs_names
  vars <- if(model != "none") vars %>% filter(type %in% c("personality", "problems") | old == model ) else vars
  vars <- vars %>% arrange(type)
  d2 %>% 
    mutate_at(vars(from_type, to_type), ~factor(., levels = c("personality", "problems"),
            labels = c("Personality", "Problems"))) %>%
    mutate_at(vars(from, to), ~factor(., levels = vars$old, labels = vars$new)) %>%
    mutate(from = forcats::fct_rev(from)) %>%
    ggplot(aes(x = to, y = from)) +
      scale_size_area(limits = c(0, 50), breaks = seq(10,50,10)
                      , max_size = 7, labels = seq(20,60,10)) +
      scale_color_manual(values = c("blue", "red")) +
      geom_point(aes(color = match, size = perc-10)) +
      labs(x = NULL
           , y = NULL
           , size = "Percentage"
           , color = NULL
           , title = str_to_title(ct)) +
      facet_grid(from_type~to_type, scales = "free",space = "free") +
      theme_classic() +
      theme(legend.position = "bottom",
            axis.text.y = element_text(face = "bold"),
            axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
            panel.background = element_rect(color = "black", fill = "white"),
            strip.text = element_text(face = "bold",size = rel(1)),
            strip.background = element_blank(),
            plot.title = element_text(face = "bold", hjust = .5))
}

Q2_edge_save_fun <- function(d2, study, model, type, level){
  p <- cowplot::plot_grid(d2$plot[[1]] + theme(legend.position = "none")
                     , d2$plot[[2]] + theme(legend.position = "none")
                     , nrow = 1)
  legend <- cowplot::get_legend(d2$plot[[1]] + theme(legend.position = "bottom"))
  p2 <- cowplot::plot_grid(p
                     , legend
                     , nrow = 2
                     , rel_heights = c(4, .4))
  ggsave(p2
         , file = sprintf("%s/results/plots/Q2/edges/%s_%s_%s.pdf"
                          , data_path, study, type, model)
         , width = 16
         , height = 8)
}

q2_edge_plot <- edge_match %>% 
  full_join(cesd %>% filter(cesd_type == "cutoff")) %>%
  filter(complete.cases(.)) %>%
  group_by(study, model) %>%
  mutate(N = length(unique(SID))) %>%
  group_by(study, model, type, from, to, N, match, from_type, to_type, cesd) %>%
  summarize(n = sum(value != 0)) %>%
  ungroup() %>%
  mutate(perc = n/N,
         var = ifelse(type == "Contemporaneous", paste(from, to, sep = "--"), 
                      paste(from, to, sep = "-->")),
         perc = round(perc*100,2),
         level = "edge") %>%
  filter(complete.cases(.)) %>%
  select(-N, -var) %>%
  group_by(study, model, type, level, cesd) %>%
  nest() %>%
  ungroup() %>%
  mutate(plot = pmap(list(data, study, type, model, cesd), Q2_plot_fun)) %>%
  group_by(study, model, type, level) %>%
  nest() %>%
  ungroup()

q2_edge_plot %>%
  mutate(pmap(list(data, study, model, type, level), Q2_edge_save_fun))

p <- cowplot::plot_grid(
  (q2_edge_plot %>% filter(type == "Contemporaneous" & study == "PAIRS"))$data[[1]]$plot[[1]] + theme(legend.position = "none")
  , (q2_edge_plot %>% filter(type == "Contemporaneous" & study == "PAIRS"))$data[[1]]$plot[[2]] + theme(legend.position = "none")
  , (q2_edge_plot %>% filter(type == "Contemporaneous" & study == "IPCS" & model == "none"))$data[[1]]$plot[[1]] + theme(legend.position = "none")
  , (q2_edge_plot %>% filter(type == "Contemporaneous" & study == "IPCS" & model == "none"))$data[[1]]$plot[[2]] + theme(legend.position = "none")
  # , rel_widths = c(.48, .52)
  , axis = "tblr"
  , align = "hv")
legend <- cowplot::get_legend(
  (q2_edge_plot %>% filter(type == "Contemporaneous" & study == "PAIRS"))$data[[1]]$plot[[1]])
  p2 <- cowplot::plot_grid(p
                     , legend
                     , nrow = 2
                     , rel_heights = c(4, .4))
p2
ggsave(file = sprintf("%s/results/plots/Q2/Figure_4.pdf", data_path)
       , width = 11
       , height = 11)
```


### Node-wise  

```{r}
Q2_node_plot_fun <- function(d1, study, model, ct){
  cb <- if(study == "PAIRS") pairs_names else ipcs_names
  d1 %>%
    left_join(cb %>% rename(var = old, var_type = type)) %>%
    filter(!is.na(var)) %>%
    mutate(var = factor(var, levels = cb$old, labels = cb$new),
           measure = factor(measure, levels = meas$old, labels = meas$new),
           match = str_to_title(str_replace(match, "_", " ")),
           var_type = str_to_title(var_type)) %>%
    distinct() %>%
    ggplot(aes(x = var, y = node_cent, shape = match)) +
    geom_line(aes(group = match, linetype = match)) +
      # scale_y_continuous(limits = c(-.05, .80), breaks = seq(0, .8, .25)) +
      # scale_y_continuous(limits = c(-1.6, 1.6), breaks = seq(-1.5, 1.5, 1.5)) +
      geom_point() +
      labs(y = "Node Centrality"
           , x = NULL
           , fill = NULL
           , linetype = "Matched"
           , shape = "Matched"
           , title = str_to_title(ct)) +
      coord_flip() +
      facet_grid(var_type~measure, scales = "free", space = "free_y") +
      theme_classic() +
      theme(legend.position = "bottom",
            axis.text = element_text(face = "bold"),
            panel.background = element_rect(color = "black", fill = "white"),
            strip.text = element_text(face = "bold", size = rel(.7)),
            strip.background = element_blank(),
            plot.title = element_text(face = "bold", hjust = .5))
}

Q2_node_save_fun <- function(d2, study, model, type){
  p <- cowplot::plot_grid(d2$plot[[1]] + theme(legend.position = "none")
                     , d2$plot[[2]] + theme(legend.position = "none")
                     , nrow = 1)
  legend <- cowplot::get_legend(d2$plot[[1]] + theme(legend.position = "bottom"))
  p2 <- cowplot::plot_grid(p
                     , legend
                     , nrow = 2
                     , rel_heights = c(4, .4))
  ggsave(p2
         , file = sprintf("%s/results/plots/Q2/nodes/%s_%s_%s.pdf"
                          , data_path, study, model, type)
         , width = if(type == "Lagged") 12 else 8
         , height = 5)
}


q2_node_plot <- node_match %>% 
  select(-e_list) %>%
  unnest(match) %>% 
  full_join(cesd %>% filter(cesd_type == "cutoff")) %>%
  filter(complete.cases(.)) %>% # & grepl("rength", measure)) %>%
  group_by(study, model, SID, type, match, cesd_type,measure, cesd) %>%
  mutate(node_cent = as.numeric(scale(node_cent)),
         node_cent = ifelse(is.nan(node_cent), 0, node_cent)) %>%
  group_by(study, model, type, var, match, measure, cesd_type, cesd) %>%
  summarize(node_cent = mean(node_cent)) %>%
  ungroup() %>%
  distinct() %>%
  group_by(study, model, cesd, type) %>%
  nest() %>%
  ungroup() %>%
  mutate(plot = pmap(list(data, study, model, cesd), Q2_node_plot_fun)) %>%
  group_by(study, model, type) %>%
  nest() %>%
  ungroup()


p <- cowplot::plot_grid(
  (q2_node_plot %>% filter(study == "PAIRS" & type == "Contemporaneous"))$data[[1]]$plot[[1]] + 
    theme(legend.position = "none"
          , axis.text.x = element_blank()
          , axis.title.x = element_blank()) 
  , (q2_node_plot %>% filter(study == "PAIRS" & type == "Contemporaneous"))$data[[1]]$plot[[2]] + 
    theme(legend.position = "none"
          , axis.text.x = element_blank()
          , axis.title.x = element_blank()) 
  , (q2_node_plot %>% filter(study == "IPCS" & model == "none" & type == "Contemporaneous"))$data[[1]]$plot[[1]] +
    theme(legend.position = "none")
  , (q2_node_plot %>% filter(study == "IPCS" & model == "none" & type == "Contemporaneous"))$data[[1]]$plot[[2]] +
    theme(legend.position = "none")
  , axis = "lrtb"
  , align = "hv"
  , nrow = 2
  , rel_heights = c(.45, .55)
)

legend <- cowplot::get_legend((q2_node_plot %>% filter(study == "PAIRS"))$data[[1]]$plot[[2]])

  p2 <- cowplot::plot_grid(p
                     , legend
                     , nrow = 2
                     , rel_heights = c(4, .4))
p2
ggsave(file = sprintf("%s/results/plots/Q2/Figure_5.pdf", data_path)
       , width = 8
       , height = 8)


q2_node_plot %>%
  mutate(pmap(list(data, study, model, type), Q2_node_save_fun))
```

## Network  

### Plots  
```{r}
net_match %>%
  filter(model == "none") %>%
  ggplot(aes(x = node_cent, y = measure)) +
    geom_density_ridges(aes(fill = match), alpha = .25) + 
    facet_grid(type~study, scales = "free_y", space = "free_y") +
    theme_classic()
```

# Q3: 

```{r}
q3_node_data <- node_match %>% 
  select(-e_list) %>% 
  unnest(match) %>%
  filter(study == "IPCS" & 
           model %in% c("none", "argument", "AnxSWk") &
           type == "Contemporaneous") %>%
  group_by(study, model, SID, type, match, measure) %>%
  mutate(node_cent = as.numeric(scale(node_cent)),
         node_cent = ifelse(is.nan(node_cent), 0, node_cent)) %>%
  group_by(study, model, type, var, match, measure) %>%
  summarize(node_cent = mean(node_cent, na.rm = T)) %>%
  left_join(ipcs_names %>% rename(var = old, var_type = type)) %>%
  mutate(var = factor(var, levels = rev(ipcs_names$old), labels = str_to_title(rev(ipcs_names$new))),
         match = factor(match, levels = c("match", "no_match"), labels = c("Matched", "Not Matched")),
         var_type = str_to_title(var_type),
         model = factor(model, levels = c("none", "argument", "AnxSWk"), labels = c("None", "Argument", "Anxious about schoolwork"))) %>%
  ungroup() %>%
  filter(complete.cases(.))

p1 <- q3_node_data %>%
  filter(measure == "strength") %>%
  ggplot(aes(x = var, y = node_cent)) + 
    # scale_y_continuous(limits = c(-1.1, 1.2), breaks = seq(-1,1,.5)) +
    geom_point(aes(shape = model), size = 1) +
    geom_line(aes(linetype = model, group = model), size = .25) +
    labs(x = NULL
         , y = "Centrality"
         , title = "Strength"
         , linetype = "Situation"
         , shape = "Situation") +
    coord_flip() +
    facet_grid(var_type ~ match, scales = "free_y", space = "free") +
    theme_classic() +
    theme(legend.position = "bottom"
          , panel.background = element_rect(color = "black")
          , strip.background = element_blank()
          , strip.text = element_text(face = "bold")
          , plot.title = element_text(face = "bold", hjust = .5)
          )

p2 <- q3_node_data %>%
  filter(measure == "degree") %>%
  ggplot(aes(x = var, y = node_cent)) + 
    geom_point(aes(shape = model), size = 1) +
    geom_line(aes(linetype = model, group = model), size = .25) +
    # scale_y_continuous(limits = c(-1.1, 1.2), breaks = seq(-1,1,.5)) +
    labs(x = NULL
         , y = "Centrality"
         , title = "Degree"
         , linetype = "Situation"
         , shape = "Situation") +
    coord_flip() +
    facet_grid(var_type~ match, scales = "free_y", space = "free") +
    theme_classic() +
    theme(legend.position = "bottom"
          , panel.background = element_rect(color = "black")
          , strip.background = element_blank()
          , strip.text = element_text(face = "bold")
          , plot.title = element_text(face = "bold", hjust = .5)
          )

p <- cowplot::plot_grid(
  p1 + theme(legend.position = "none"
          , strip.background.y = element_blank()
          , strip.text.y =  element_blank()
          )
  , p2 + 
    theme(legend.position = "none"
          , axis.text.y = element_blank()
          , axis.ticks.y = element_blank()
          )
  , nrow = 1
  , rel_widths = c(.56, .42))
  legend <- cowplot::get_legend(p1 + theme(legend.position = "bottom"))
p <- cowplot::plot_grid(p
                     , legend
                     , nrow = 2
                     , rel_heights = c(4, .4))
p
ggsave(p
       , file = sprintf("%s/results/plots/Q3/node_plot.png", data_path)
       , width = 6
       , height = 4)

```

